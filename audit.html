<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2M Master System v46.1 - Total Matrix</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --sidebar-bg: rgba(15, 23, 42, 0.98);
            --border: rgba(255,255,255,0.1);
            --brand-main: #004D54; 
            --brand-accent: #2dd4bf;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-dark); color: #f8fafc; height: 100vh; overflow: hidden; margin: 0; }
        
        .main { flex: 1; overflow-y: auto; padding: 2rem; background: radial-gradient(circle at top right, #132e35 0%, #0f172a 40%); }

        .nav-btn { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; color: #94a3b8; cursor: pointer; transition: 0.2s; font-weight: 500; margin-bottom: 4px; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-btn.active { background: var(--brand-main); color: var(--brand-accent); border-left: 3px solid var(--brand-accent); }

        /* FILTER BAR */
        .apt-filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; scrollbar-width: thin; }
        .apt-btn { white-space: nowrap; padding: 8px 16px; border-radius: 99px; font-size: 0.85rem; font-weight: 600; border: 1px solid var(--border); color: #94a3b8; cursor: pointer; background: rgba(255,255,255,0.05); transition: 0.2s; }
        .apt-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .apt-btn.active { border-color: var(--brand-accent); color: #00282c; background: var(--brand-accent); box-shadow: 0 0 15px rgba(45, 212, 191, 0.3); }

        /* TAB & FILTERS */
        .type-switch { background: rgba(0,0,0,0.3); padding: 4px; border-radius: 12px; display: flex; border: 1px solid var(--border); margin-bottom: 20px; }
        .type-btn { flex: 1; padding: 10px; text-align: center; font-size: 0.85rem; font-weight: 700; color: #94a3b8; border-radius: 8px; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .type-btn.active { background: var(--brand-accent); color: #00282c; box-shadow: 0 4px 10px rgba(45, 212, 191, 0.2); }

        /* ASSET CARD */
        .audit-card { 
            background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; 
            transition: all 0.2s; position: relative; overflow: hidden; cursor: pointer;
        }
        .audit-card:hover { transform: translateY(-3px); border-color: rgba(255,255,255,0.3); background: rgba(255, 255, 255, 0.05); }
        .audit-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; }
        .type-STRUCT::before { background: #f59e0b; } /* Arancio */
        .type-MOBILE::before { background: #3b82f6; } /* Blu */

        /* MATRIX BARS */
        .bar-container { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 99px; overflow: hidden; margin-top: 4px; }
        .bar-fill { height: 100%; border-radius: 99px; }
        .fill-time { background: #3b82f6; }
        .fill-perf { background: #10b981; }
        .fill-eff { background: #f59e0b; }

        .score-badge { position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px; border-radius: 50%; border: 3px solid; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.8rem; background: rgba(15,23,42,0.8); }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
        .modal-box { background: #1e293b; border: 1px solid var(--border); width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        /* PARTS TABLE */
        .parts-table { width: 100%; font-size: 0.85rem; text-align: left; border-collapse: collapse; }
        .parts-table th { color: #94a3b8; font-weight: 600; padding: 10px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .parts-table td { padding: 10px; border-bottom: 1px solid var(--border); color: #e2e8f0; }
        .tag-crit-high { color: #ef4444; font-weight: bold; }
        .tag-crit-med { color: #f59e0b; }
        .tag-crit-low { color: #34d399; }
    </style>
<style id="masotto-sidebar-css">
:root{
  --bg-dark:#0b1220;
  --panel:rgba(255,255,255,.04);
  --border:rgba(255,255,255,.10);
  --brand:#004D54;
  --accent:#2dd4bf;
}
body{background:var(--bg-dark);}
.ms-sidebar{
  position:fixed; inset:0 auto 0 0;
  width:260px; background:rgba(15,23,42,.96);
  border-right:1px solid var(--border);
  padding:20px; z-index:50; overflow:auto;
}
.ms-main{margin-left:260px; min-height:100vh;}
@media (max-width: 900px){
  .ms-sidebar{transform:translateX(-105%); transition:.2s;}
  .ms-sidebar.open{transform:translateX(0);}
  .ms-main{margin-left:0;}
  .ms-topbar{position:sticky; top:0; z-index:40; backdrop-filter: blur(10px);
    background:rgba(11,18,32,.75); border-bottom:1px solid var(--border);}
}
.ms-nav a{
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:10px;
  color:#94a3b8; font-weight:600; text-decoration:none;
}
.ms-nav a:hover{background:rgba(255,255,255,.05); color:#fff;}
.ms-nav a.active{background:var(--brand); color:var(--accent); border-left:3px solid var(--accent);}
.ms-chip{font:600 10px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  color:var(--accent); background:rgba(45,212,191,.10); border:1px solid rgba(45,212,191,.25);
  padding:2px 8px; border-radius:999px; display:inline-block;}
</style>
    <script src="masotto_db.js"></script>
</head>
<body>

    <div id="detailModal" class="modal-overlay">
        <div class="modal-box">
            <div class="bg-slate-900 p-6 border-b border-white/10 flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span id="m-code" class="text-xs font-mono bg-white/10 px-2 py-0.5 rounded text-teal-400">CODE</span>
                        <span id="m-type" class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border">TYPE</span>
                    </div>
                    <h2 id="m-title" class="text-2xl font-bold text-white">Asset Name</h2>
                    <div class="text-sm text-gray-400 mt-1" id="m-apt">Apartment</div>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            
            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <div>
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Analisi Decadenza (3-Matrix)</h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-xs mb-1"><span class="text-blue-400">Tempo (Et√†)</span> <span id="val-time" class="text-white font-bold">0%</span></div>
                                <div class="bar-container"><div id="bar-time" class="bar-fill fill-time" style="width:0%"></div></div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1"><span class="text-green-400">Performance</span> <span id="val-perf" class="text-white font-bold">0%</span></div>
                                <div class="bar-container"><div id="bar-perf" class="bar-fill fill-perf" style="width:0%"></div></div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1"><span class="text-yellow-400">Efficienza</span> <span id="val-eff" class="text-white font-bold">0%</span></div>
                                <div class="bar-container"><div id="bar-eff" class="bar-fill fill-eff" style="width:0%"></div></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-white/5 rounded-lg border border-white/10">
                        <h4 class="text-xs font-bold text-white mb-2">Dati Tecnici</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="text-gray-500">Installazione:</div> <div class="text-right text-white" id="m-year">-</div>
                            <div class="text-gray-500">Vita Utile:</div> <div class="text-right text-white" id="m-life">-</div>
                            <div class="text-gray-500">Maint. Factor:</div> <div class="text-right text-teal-400" id="m-maint">-</div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="flex justify-between items-end mb-3">
                        <h3 class="text-sm font-bold text-white uppercase flex items-center gap-2"><i data-lucide="wrench" class="w-4 h-4 text-teal-400"></i> Ricambi & Manutenzione</h3>
                    </div>
                    <div class="overflow-hidden rounded-lg border border-white/10 bg-black/20">
                        <table class="parts-table">
                            <thead>
                                <tr>
                                    <th>Cod.</th>
                                    <th>Descrizione</th>
                                    <th>Stock</th>
                                    <th>Costo (‚Ç¨)</th>
                                    <th>Criticit√†</th>
                                </tr>
                            </thead>
                            <tbody id="m-parts-body">
                                </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex gap-2 justify-end">
                        <button class="px-4 py-2 bg-white/5 hover:bg-white/10 text-white text-xs font-bold rounded border border-white/10">Segnala Guasto</button>
                        <button class="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white text-xs font-bold rounded shadow-lg shadow-teal-900/50">Ordina Ricambi</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div>
        

        <main class="main">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold text-white">Audit & Matrix Decadenza</h2>
                    <div class="text-xs text-gray-400">Database Completo (Reale)</div>
                </div>
                
                <div class="apt-filters" id="apt-filters"><span class="apt-btn active">Masotto Terrace View</span></div>

                <div class="type-switch">
                    <div onclick="setType('STRUCT')" class="type-btn active" id="btn-STRUCT">üèóÔ∏è STRUTTURALI (Impianti, Pareti)</div>
                    <div onclick="setType('MOBILE')" class="type-btn" id="btn-MOBILE">üõãÔ∏è MOBILI (Elettrodomestici, Arredi)</div>
                </div>
            </div>

            <div id="audit-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                </div>
        </main>
    </div>

    <script>
        // --- DATI: SOLO MASOTTO (da masotto_complete_database.json -> localStorage) ---
        function loadMasottoAssetsFromLS(){
            let mobile = [];
            let structural = [];
            try{
              mobile = JSON.parse(localStorage.getItem('masotto_assets_mobile_db') || '[]');
              structural = JSON.parse(localStorage.getItem('masotto_structural_assets_db') || '[]');
            }catch(e){}

            // fallback: embedded master DB (works even if localStorage is empty)
            if((!mobile || !mobile.length) && window.MASOTTO_DB && Array.isArray(window.MASOTTO_DB.assets_mobile)){
              mobile = window.MASOTTO_DB.assets_mobile;
            }
            if((!structural || !structural.length) && window.MASOTTO_DB && Array.isArray(window.MASOTTO_DB.structural_assets)){
              structural = window.MASOTTO_DB.structural_assets;
            }

            const mobiles = (mobile||[]).map(a => ({
                asset_code: a.id,
                asset_name: `${a.tipo}${a.marca ? ' ' + a.marca : ''}${a.modello ? ' ' + a.modello : ''}`.trim(),
                type: 'MOBILE',
                year: (a.acquisto ? parseInt(String(a.acquisto).slice(0,4),10) : new Date().getFullYear()),
                serial: a.sn || '-',
                warranty: a.garanzia || '-',
                assistenza: a.assistenza || '-',
                note: ''
            }));

            const structurals = (structural||[]).map(s => ({
                asset_code: s.id,
                asset_name: s.nome || s.id,
                type: 'STRUCT',
                year: (s.anno_installazione ? parseInt(String(s.anno_installazione).slice(0,4),10) : new Date().getFullYear()),
                serial: '-',
                warranty: s.vita_utile_anni ? `Vita utile: ${s.vita_utile_anni} anni` : '-',
                assistenza: '-',
                note: s.note || ''
            }));

            return [...mobiles, ...structurals];
        }

// --- 2. CONFIGURAZIONE ---
        let ASSETS = [];
        let CURR_TYPE = 'STRUCT';
        let CURR_APT = 'Masotto Terrace View';

        function getApt(){ return 'Masotto Terrace View'; }
function getMatrix(code, type, name, baseYear, baseLife){
            let year = (baseYear || 2023);
            let life = (baseLife || (type==='STRUCT' ? 30 : 8));
            
            // Logica Stima Anni (APE + Real Data)
            if(code.includes('EQ76') || code.includes('EQ99')) year = 2023; // Nuovi
            if(code.includes('EQ35') || code.includes('EQ60')) year = 2015; // Caldaie vecchie
            if(code.startsWith('P01')) year = 2017; // Heritage Ristrutt.
            if(code.startsWith('P05')) year = 1960; // Masotto (vecchio)
            if(name.toLowerCase().includes('terrazzo')) year = 2024; // Lavori recenti

            const now = new Date().getFullYear();
            const age = now - year;
            const t = Math.max(0, Math.round(100 - (age/life)*100));
            
            return {
                year: year,
                life: life,
                maint: 0.1,
                t: t,
                p: t > 50 ? 90 : 60,
                e: type==='STRUCT' ? 70 : 90,
                g: Math.round((t*0.3)+(90*0.4)+(80*0.3))
            };
        }

        // --- 3. INIT & RENDER ---
        function init() {
            ASSETS = loadMasottoAssetsFromLS().map(d => {
                const mx = getMatrix(d.asset_code, d.type, d.asset_name, d.year, d.life);
                return { ...d, ...mx };
            });
updateKPI();
            renderFilters();
            renderGrid();
            lucide.createIcons();
        }

        function updateKPI() {
            document.getElementById('kpi-tot').innerText = ASSETS.length;
            document.getElementById('kpi-struct').innerText = ASSETS.filter(a=>a.type==='STRUCT').length;
            document.getElementById('kpi-mobile').innerText = ASSETS.filter(a=>a.type==='MOBILE').length;
        }

        function renderFilters(){ /* single-property mode: no apartment selector */ }

        function renderGrid() {
            const container = document.getElementById('audit-grid');
            const filtered = ASSETS.filter(a => a.type === CURR_TYPE);
            
            if(filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-12 text-gray-500 italic">Nessun asset.</div>`;
                return;
            }

            container.innerHTML = filtered.map(a => {
                let scoreColor = a.g > 70 ? '#10b981' : (a.g > 40 ? '#f59e0b' : '#ef4444');
                let icon = a.type === 'STRUCT' ? 'hammer' : 'box';
                if(a.asset_name.toLowerCase().includes('clima')) icon = 'snowflake';
                if(a.asset_name.toLowerCase().includes('caldaia')) icon = 'flame';

                return `
                <div class="audit-card type-${a.type}" onclick="openModal('${a.asset_code}')">
                    <div class="score-badge" style="border-color:${scoreColor}; color:${scoreColor}">${a.g}</div>
                    
                    <div class="pr-10">
                        <div class="text-[10px] font-bold text-teal-400 uppercase tracking-wider mb-1">${a.apt}</div>
                        <h3 class="text-lg font-bold text-white leading-tight mb-3 flex items-center gap-2">
                            <i data-lucide="${icon}" class="w-4 h-4 text-gray-400"></i> ${a.asset_name}
                        </h3>
                    </div>

                    <div class="space-y-1 mb-3">
                        <div class="flex items-center gap-2 text-[10px] text-blue-300">
                            <i data-lucide="clock" class="w-3 h-3"></i> <div class="bar-container"><div class="bar-fill fill-time" style="width:${a.t}%"></div></div>
                        </div>
                        <div class="flex items-center gap-2 text-[10px] text-green-300">
                            <i data-lucide="activity" class="w-3 h-3"></i> <div class="bar-container"><div class="bar-fill fill-perf" style="width:${a.p}%"></div></div>
                        </div>
                        <div class="flex items-center gap-2 text-[10px] text-yellow-300">
                            <i data-lucide="zap" class="w-3 h-3"></i> <div class="bar-container"><div class="bar-fill fill-eff" style="width:${a.e}%"></div></div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-t border-white/5 pt-2 mt-2">
                        <span class="text-[10px] text-gray-500 font-mono">${a.asset_code}</span>
                        <span class="text-[10px] text-teal-500 font-bold uppercase flex items-center gap-1">Dettagli <i data-lucide="arrow-right" class="w-3 h-3"></i></span>
                    </div>
                </div>`;
            }).join('');
            
            lucide.createIcons();
        }

        function setApt(){ /* n/a */ }
function setType(t) { CURR_TYPE = t; document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+t).classList.add('active'); renderGrid(); }

        function openModal(code) {
            const a = ASSETS.find(x => x.asset_code === code);
            
            document.getElementById('m-title').innerText = a.asset_name;
            document.getElementById('m-code').innerText = a.asset_code;
            document.getElementById('m-type').innerText = a.type;
            document.getElementById('m-apt').innerText = a.apt;
            
            document.getElementById('bar-time').style.width = a.t + '%'; document.getElementById('val-time').innerText = a.t + '%';
            document.getElementById('bar-perf').style.width = a.p + '%'; document.getElementById('val-perf').innerText = a.p + '%';
            document.getElementById('bar-eff').style.width = a.e + '%'; document.getElementById('val-eff').innerText = a.e + '%';
            
            document.getElementById('m-year').innerText = a.year;
            document.getElementById('m-life').innerText = a.life + ' anni';
            document.getElementById('m-maint').innerText = (a.maint * 100) + '%';

            const tbody = document.getElementById('m-parts-body');
            if(a.spare_parts && a.spare_parts.length > 0) {
                tbody.innerHTML = a.spare_parts.map(p => `
                    <tr>
                        <td class="font-mono text-gray-400 text-xs">${p.part_id}</td>
                        <td class="font-bold text-white">${p.description}</td>
                        <td class="text-center text-gray-400">${p.stock_min}</td>
                        <td class="text-teal-400 font-mono">‚Ç¨ ${p.est_unit_cost_eur}</td>
                        <td class="tag-crit-${p.criticality}">${p.criticality.toUpperCase()}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 italic py-4">Nessun ricambio registrato.</td></tr>`;
            }

            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('detailModal').style.display = 'none'; }

        window.addEventListener('DOMContentLoaded', init);
    </script>
<script id="masotto-sidebar">
(function(){
  const PAGES = [
    ["index.html","Dashboard","layout-dashboard"],
    ["ANAGRAFICA.html","Anagrafica","id-card"],
    ["asset.html","Asset","boxes"],
    ["audit.html","Audit","clipboard-check"],
    ["manutenzione.html","Manutenzione","wrench"],
    ["prenotazioni.html","Prenotazioni","calendar"],
    ["FINANZE.html","Finanze","pie-chart"],
    ["conto.html","Conto","wallet"],
    ["consuntivo_25.html","Consuntivo 2025","file-text"],
    ["sicurezza.html","Sicurezza","shield"]
  ];

  function purgeOtherAlloggi(){
    try{
      const kill = ["nolo","suite","nest","studio","heritage","bassano","chavez","termopili"];
      Object.keys(localStorage).forEach(k=>{
        const lk = k.toLowerCase();
        if(k.startsWith("masotto_")) return;
        if(kill.some(t=>lk.includes(t))) localStorage.removeItem(k);
      });
          window.__MS_SIDEBAR_DONE = true;
}catch(e){}
  }

  async function ensureMasterDB(force=false){
    try{
      let master = null;

      // 1) prefer embedded DB (works also on file://)
      if(window.MASOTTO_DB) master = window.MASOTTO_DB;

      // 2) otherwise try fetch (works when served via http://)
      if(!master){
        const res = await fetch("masotto_complete_database.json", {cache:"no-store"});
        if(!res.ok) throw new Error("fetch failed");
        master = await res.json();
      }

      const map = {
        "masotto_prop_data": "property_master",
        "masotto_assets_mobile_db": "assets_mobile",
        "masotto_structural_assets_db": "structural_assets",
        "masotto_finance_db": "finances",
        "masotto_booking_db": "bookings",
        "masotto_maint_db": "tickets",
        "masotto_insurance_db": "insurance",
        "masotto_utilities_db": "utilities",
        "masotto_contacts_db": "contacts",
        "masotto_maintenance_presets_db": "maintenance_presets"
      };

      purgeOtherAlloggi();

      for(const [lsKey, section] of Object.entries(map)){
        const existing = localStorage.getItem(lsKey);
        const isEmpty = !existing || existing==="null" || existing==="[]" || existing==="{}";
        if(force || isEmpty){
          localStorage.setItem(lsKey, JSON.stringify(master[section] ?? []));
        }
      }

      localStorage.setItem("active_property", "Masotto Terrace View");
      return true;
    }catch(e){
      return false;
    }
  }

  function mountSidebar(){
  // idempotent mount (safe even if scripts load twice)
  if (window.__MS_SIDEBAR_DONE && document.getElementById("msSidebar")) return;
  try{
    // remove legacy sidebars, but NEVER remove #msSidebar
    document.querySelectorAll("aside.sidebar, div.sidebar, #sidebar, [data-legacy-sidebar=\"1\"]").forEach(el=>el.remove());
    document.querySelectorAll(".ms-sidebar").forEach(el=>{ if(el.id !== "msSidebar") el.remove(); });
  }catch(e){}
  if (document.getElementById("msSidebar")) { window.__MS_SIDEBAR_DONE = true; return; }

  const path = (location.pathname.split("/").pop() || "index.html");
    const nav = PAGES.map(([href,label,icon])=>{
      const active = (href.toLowerCase() === path.toLowerCase()) ? "active" : "";
      return `<a class="${active}" href="${href}"><i data-lucide="${icon}" class="w-4 h-4"></i><span>${label}</span></a>`;
    }).join("");

    const sidebar = document.createElement("aside");
    sidebar.className="ms-sidebar";
    sidebar.id="msSidebar";
    sidebar.innerHTML = `
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-lg"
             style="background:linear-gradient(135deg,#004D54,#10b981)">2M</div>
        <div>
          <div class="text-white font-bold leading-tight">Masotto Terrace</div>
          <div class="ms-chip">single-property mode</div>
        </div>
      </div>
      <nav class="ms-nav space-y-1">${nav}</nav>
      <div class="mt-6 p-3 rounded-xl" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);">
        <div class="text-[11px] text-gray-400">Data source</div>
        <div class="text-[12px] text-white font-semibold">masotto_complete_database.json</div>
        <button id="msSyncBtn" class="mt-3 w-full text-xs font-bold px-3 py-2 rounded-lg"
          style="background:rgba(45,212,191,.15);border:1px solid rgba(45,212,191,.35);color:#a7f3d0;">
          Sync DB
        </button>
      </div>
    `;

    // main wrapper
    const mainWrap = document.createElement("div");
    mainWrap.className = "ms-main";
    while(document.body.firstChild){
      mainWrap.appendChild(document.body.firstChild);
    }
    document.body.appendChild(sidebar);
    document.body.appendChild(mainWrap);

    // mobile topbar + toggle
    const topbar = document.createElement("div");
    topbar.className="ms-topbar p-3 flex items-center justify-between lg:hidden";
    topbar.innerHTML = `
      <button id="msToggle" class="px-3 py-2 rounded-lg text-white text-xs font-bold"
        style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);">
        ‚ò∞ Menu
      </button>
      <div class="text-white font-bold text-sm">Masotto Terrace</div>
      <div style="width:64px"></div>
    `;
    mainWrap.prepend(topbar);

    document.getElementById("msToggle").addEventListener("click", ()=>{
      sidebar.classList.toggle("open");
    });
    document.getElementById("msSyncBtn").addEventListener("click", async ()=>{
      await ensureMasterDB(true);
      location.reload();
    });
  }

  // boot
  window.__ensureMasottoDB = ensureMasterDB;
  document.addEventListener("DOMContentLoaded", async ()=>{
    await ensureMasterDB(false);
    mountSidebar();
    if(window.lucide && window.lucide.createIcons) window.lucide.createIcons();
  });
})();
</script>
    
</body>
</html>